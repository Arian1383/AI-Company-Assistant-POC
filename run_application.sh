#!/bin/bash

# ุฑูุชู ุจู ูพูุดู ุฑุดู ูพุฑูฺู (ุงฺฏุฑ ุงุฒ ุฌุง ุฏฺฏุฑ ุงุฌุฑุง ุดูุฏ)
cd "$(dirname "$0")"

echo "๐ ุฏุฑ ุญุงู ููฺฏุงูโุณุงุฒ ุชุบุฑุงุช ุจุง GitHub..."

# ุงุถุงูู ฺฉุฑุฏู ุชูุงู ูุงูโูุง ุจุฑุง Commit
git add .

# ุงุฌุงุฏ ฺฉ Commit ุฌุฏุฏ (ุงฺฏุฑ ุชุบุฑ ูุฌูุฏ ุฏุงุดุชู ุจุงุดุฏ)
# ุงุฒ git diff-index ุจุฑุง ุจุฑุฑุณ ูุฌูุฏ ุชุบุฑุงุช ุงุณุชูุงุฏู ู ฺฉูู
if ! git diff-index --quiet HEAD --; then
    git commit -m "Automated commit: Syncing changes before running application"
    if [ $? -ne 0 ]; then # ุจุฑุฑุณ ููููุช ุขูุฒ ุจูุฏู commit
        echo "โ ุฎุทุง ุฏุฑ Commit ฺฉุฑุฏู ุชุบุฑุงุช. ูุทูุง ุจู ุตูุฑุช ุฏุณุช ุจุฑุฑุณ ฺฉูุฏ."
        exit 1 # ุฎุฑูุฌ ุจุง ุฎุทุง
    fi
else
    echo "โ ูฺ ุชุบุฑ ุจุฑุง Commit ฺฉุฑุฏู ูุฌูุฏ ูุฏุงุฑุฏ."
fi

# ุงุฑุณุงู ุชูุงู ุชุบุฑุงุช ุจู GitHub (ุจุง ุงุฌุจุงุฑ)
git push -u origin main --force
if [ $? -ne 0 ]; then # ุจุฑุฑุณ ููููุช ุขูุฒ ุจูุฏู push
    echo "โ ุฎุทุง ุฏุฑ Push ฺฉุฑุฏู ุชุบุฑุงุช ุจู GitHub. ูุทูุง ุจู ุตูุฑุช ุฏุณุช ุจุฑุฑุณ ฺฉูุฏ."
    exit 1 # ุฎุฑูุฌ ุจุง ุฎุทุง
fi

echo "โ ุชุบุฑุงุช ุจุง ููููุช ุจู GitHub ููุชูู ุดุฏ."

# ูุนุงู ฺฉุฑุฏู ูุญุท ูุฌุงุฒ
echo "โ๏ธ ุฏุฑ ุญุงู ูุนุงูโุณุงุฒ ูุญุท ูุฌุงุฒ..."
source .venv/bin/activate
if [ $? -ne 0 ]; then # ุจุฑุฑุณ ููููุช ุขูุฒ ุจูุฏู ูุนุงู ุณุงุฒ ูุญุท ูุฌุงุฒ
    echo "โ ุฎุทุง ุฏุฑ ูุนุงูโุณุงุฒ ูุญุท ูุฌุงุฒ. ูุทูุฆู ุดูุฏ ูพูุดู .venv ูุฌูุฏ ุฏุงุฑุฏ ู pip install -r requirements.txt ุงุฌุฑุง ุดุฏู ุงุณุช."
    exit 1
fi

# ุงุฌุฑุง ุจุฑูุงูู Streamlit
echo "โจ ุฏุฑ ุญุงู ุงุฌุฑุง ุงูพูฺฉุดู Streamlit..."
streamlit run app.py --server.enableCORS false --server.enableXsrfProtection false